{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    :root {
        --primary: #4f46e5; --success: #10b981; --danger: #ef4444;
        --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0;
        --text-main: #1e293b; --text-muted: #64748b;
    }
    #content { padding: 0 !important; }
    .dashboard-container { 
        background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; 
        color: var(--text-main); padding: 2rem; min-height: 100vh;
        display: grid; grid-template-columns: 280px 1fr; gap: 2rem;
    }

    .sidebar { background: var(--card); border-radius: 24px; padding: 1.5rem; border: 1px solid var(--border); height: fit-content; position: sticky; top: 2rem; }
    .sidebar h3 { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; margin-bottom: 1rem; }
    .nav-group { margin-bottom: 2rem; }
    .nav-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 10px; text-decoration: none; color: var(--text-main); transition: 0.2s; font-size: 0.9rem; margin-bottom: 4px; }
    .nav-item:hover { background: #f1f5f9; color: var(--primary); }
    .nav-item i { width: 18px; margin-right: 10px; }
    .quick-actions { display: flex; gap: 5px; }
    .q-btn { padding: 4px; border-radius: 4px; color: var(--text-muted); transition: 0.2s; }
    .q-btn:hover { background: var(--primary); color: white; }

    .hero-banner {
        background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
        border-radius: 24px; padding: 2rem; color: white; margin-bottom: 2rem;
        display: flex; justify-content: space-between; align-items: center;
    }
    
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .kpi-card { background: white; padding: 1.5rem; border-radius: 20px; border: 1px solid var(--border); }
    .kpi-card strong { font-size: 2rem; display: block; margin: 5px 0; }

    .response-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 1rem; border-radius: 12px; margin-top: 1rem; }
    .progress-bar { width: 100%; height: 8px; background: #dcfce7; border-radius: 10px; margin-top: 10px; position: relative; }
    .progress-fill { height: 100%; background: var(--success); border-radius: 10px; transition: 1s; }

    .main-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .glass-card { background: white; border-radius: 20px; border: 1px solid var(--border); padding: 1.5rem; }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; border-bottom: 2px solid var(--bg); }
    td { padding: 14px 12px; border-bottom: 1px solid var(--bg); font-size: 0.9rem; }
    
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
    .status-replied { background: #dcfce7; color: #15803d; }
    .status-pending { background: #fee2e2; color: #991b1b; }

    @media (max-width: 1100px) { .dashboard-container { grid-template-columns: 1fr; } .sidebar { display: none; } }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <aside class="sidebar">
    <div class="nav-group">
        <h3>Leads Management</h3>
        <a href="{% url 'admin:shop_enquiry_changelist' %}" class="nav-item">
            <span><i data-lucide="users"></i> All Enquiries</span>
        </a>
        <a href="{% url 'admin:shop_enquiry_changelist' %}?status__exact=responded" class="nav-item">
            <span><i data-lucide="message-square"></i> My Responses</span>
        </a>
    </div>

    <div class="nav-group">
        <h3>Inventory & Catalog</h3>
        <a href="{% url 'admin:shop_product_changelist' %}" class="nav-item">
            <span><i data-lucide="package"></i> Products</span>
        </a>
        <a href="{% url 'admin:shop_category_changelist' %}" class="nav-item">
            <span><i data-lucide="layers"></i> Categories</span>
        </a>
    </div>

    <div class="nav-group">
        <h3>Support</h3>
        <a href="/admin/doc/" class="nav-item"><i data-lucide="help-circle"></i> Documentation</a>
        <a href="/admin/password_change/" class="nav-item"><i data-lucide="settings"></i> Settings</a>
    </div>
</aside>
    <main>
        <div class="hero-banner">
            <div>
                <h1 id="greet" style="margin:0; font-weight:800;">Welcome</h1>
                <p style="margin:5px 0 0 0; opacity: 0.9;">Control your business catalog and lead responses here.</p>
            </div>
            <button class="btn" style="background:white; color:var(--primary); padding:10px 20px; border-radius:12px; border:none; font-weight:700; cursor:pointer;" onclick="window.print()">Print Report</button>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span style="color:var(--text-muted); font-size:0.8rem; font-weight:700;">TOTAL RECEIVED</span>
                <strong>{{ total_enquiries|default:"0" }}</strong>
                <small>Total lifecycle enquiries</small>
            </div>
            <div class="kpi-card">
                <span style="color:var(--success); font-size:0.8rem; font-weight:700;">RESPONDED</span>
                <strong>{{ responded_count|default:"0" }}</strong>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ response_rate|default:'0' }}%;"></div>
                </div>
            </div>
            <div class="kpi-card">
                <span style="color:var(--danger); font-size:0.8rem; font-weight:700;">AWAITING REPLY</span>
                <strong>{{ followups_due|default:"0" }}</strong>
                <small>Needs immediate attention</small>
            </div>
        </div>

        <div class="main-grid">
            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                    <h3 style="margin:0;">Recent Enquiries & Response Status</h3>
                    <input type="text" id="leadSearch" placeholder="Search leads..." style="padding:8px 15px; border-radius:8px; border:1px solid var(--border); width:250px;">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Lead Name</th>
                            <th>Product</th>
                            <th>Status</th>
                            <th>Reply Status</th>
                            <th style="text-align:right;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="leadTableBody">
                        {% for e in recent_enquiries %}
                        <tr class="lead-row">
                            <td style="font-weight:600;">{{ e.name }}</td>
                            <td>{{ e.product.name|default:"General" }}</td>
                            <td>{{ e.get_status_display }}</td>
                            <td>
                                {% if e.status != 'new' %}
                                <span class="badge status-replied"><i data-lucide="check-circle" style="width:12px; display:inline-block;"></i> Responded</span>
                                {% else %}
                                <span class="badge status-pending">Awaiting Reply</span>
                                {% endif %}
                            </td>
                            <td style="text-align:right;">
                                <a href="{% url 'admin:shop_enquiry_change' e.id %}" style="color:var(--primary); font-weight:700; text-decoration:none;">Open</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script>
    lucide.createIcons();

    const hour = new Date().getHours();
    const name = "{{ user.first_name|default:user.username }}";
    const greet = document.getElementById('greet');
    if (hour < 12) greet.innerText = `Good Morning, ${name} ðŸŒ…`;
    else if (hour < 18) greet.innerText = `Good Afternoon, ${name} â˜€ï¸`;
    else greet.innerText = `Good Evening, ${name} ðŸŒ™`;

    document.getElementById('leadSearch').addEventListener('keyup', function() {
        let value = this.value.toLowerCase();
        let rows = document.querySelectorAll('#leadTableBody .lead-row');
        rows.forEach(row => {
            row.style.display = (row.innerText.toLowerCase().includes(value)) ? "" : "none";
        });
    });
</script>
{% endblock %}